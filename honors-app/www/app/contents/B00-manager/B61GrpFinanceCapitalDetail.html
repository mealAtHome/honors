<ons-page id="GFCP">

    <!-- --------------- -->
    <!-- 페이지용 타이틀 -->
    <!-- --------------- -->
    <ons-toolbar id="GFCP-toolbar">
        <div class="left"><gg-backbtn onclick="GFCP.close(true);"></gg-backbtn></div>
        <div class="center"><span id="GFCP-span-title">자본금</span></div>
    </ons-toolbar>

    <div class="common-div-formChild">

        <!-- --------------- -->
        <!-- 탭 -->
        <!-- --------------- -->
        <div class="common-div-cushionUD">
            <button class="GFCP-btn-tab commonEvent-btn-radio common-btn-radio" radio_name="GFCP-btn-tab" val="input"   tab="">자본금 변경</button>
            <button class="GFCP-btn-tab commonEvent-btn-radio common-btn-radio" radio_name="GFCP-btn-tab" val="history" tab="">변경이력</button>
        </div>
        <hr class="common-hr-paddingUD"/>

        <!-- --------------- -->
        <!-- 자본금 변경 -->
        <!-- --------------- -->
        <div class="GFCP-div-tab" tab="input">

            <!-- 타이틀 -->
            <div class="common-div-formTitle">
                <span>자본금 변경</span>
                <!-- <span class="GFCP-span-choosedPosition"></span> -->
            </div>

            <!-- 안내 -->
            <ul class="common-ul-announce">
                <li>모임의 기존 자본금을 표시합니다.</li>
                <li>모임을 운영중에 저희 시스템을 도입했을 때, 도입 당시까지의 누적금 등을 관리하는 용도로 사용할 수 있습니다.</li>
            </ul>

            <!-- 자본금 변경 -->
            <div class="common-div-formField">
                <span>자본금</span>
                <span>숫자만 입력하실 수 있습니다.</span>
                <input id="GFCP-input-capital" type="number" class="common-input-field"/>
                <div class="common-div-cushionUD">
                    <div class="common-tag-block"><span>현재 자본금 : </span><span id="GFCP-span-originalWon"    number=""></span></div>
                    <div class="common-tag-block"><span>입력 자본금 : </span><span id="GFCP-span-capitalWon"     number=""></span></div>
                    <div class="common-tag-block"><span>자본금 차액 : </span><span id="GFCP-span-differenceWon"  number=""></span></div>
                </div>
            </div>

            <!-- 코멘트 입력 -->
            <div class="common-div-formField">
                <span>변경사유</span>
                <span>자본금 변경사유를 입력해주세요.</span>
                <textarea id="GFCP-textarea-comment" class="common-textarea-field" rows="5" placeholder="변경사유를 입력해주세요."></textarea>
            </div>

            <!-- 다음으로 -->
            <table class="common-tbl-slideformFooterBtn" tbl-type="button1">
                <tbody>
                    <tr>
                        <td><button id="GFCP-btn-apply" class="common-btn-inline">적용하기</button></td>
                    </tr>
                </tbody>
            </table>

        </div> <!-- 자본금 변경 -->

        <!-- --------------- -->
        <!-- 변경이력 -->
        <!-- --------------- -->
        <div class="GFCP-div-tab" tab="history" style="display:none;">

            <!-- 타이틀 -->
            <div class="common-div-formTitle">
                <span>자본금 변경이력</span>
                <!-- <span class="GFCP-span-choosedPosition"></span> -->
            </div>

            <!-- 변경이력 전체 -->
            <div class="common-div-formField">
                <span>변경이력 전체</span>
                <span>모임의 자본금 변경이력을 모두 표시합니다.</span>
                <div id="GFCP-div-historyAll"></div>
            </div>

        </div> <!-- 변경이력 -->

    </div> <!-- formChild -->

    <script>
        var GFCP =
        {
            code : "GFCP",
            Data: {},

            /* ===================== */
            /* show */
            /* ===================== */
            show()
            {
                if(Common.isEmpty(GFCP.Data.grpno)) { Common.toast("잘못된 접근입니다."); GFCP.close(true); return; }
                if(Common.isEmpty(GFCP.Data.tab))   { GFCP.Data.tab = "input"; }

                /* init */
                Common.showProgress();
                setTimeout(function()
                {
                    try
                    {
                        /* vars */
                        let grpno = GFCP.Data.grpno;

                        /* get capital */
                        let mGrpformng = Api.Grpformng.selectByPk(grpno).getModel();
                        if(mGrpformng == null)
                        {
                            Common.toast("모임 정보를 불러올 수 없습니다.");
                            GFCP.close(true);
                            return;
                        }

                        /* init html */
                        $("#GFCP-input-capital").val(mGrpformng.getGrpfncCapitaltotal());
                        $("#GFCP-span-originalWon").html(mGrpformng.getGrpfncCapitaltotalWon());
                        $("#GFCP-span-originalWon").attr("number", mGrpformng.getGrpfncCapitaltotal());
                        $("#GFCP-input-capital").keyup();

                        /* choose tab */
                        $(`.GFCP-btn-tab[val="${GFCP.Data.tab}"]`).click();
                    }
                    catch(e)
                    {
                        Common.toast("오류가 발생했습니다.");
                        GFCP.close(true);
                        return;
                    }
                    finally
                    {
                        Common.hideProgress();
                    }
                }, ajaxDelayTime);
            },

            /* ========================= */
            /* close */
            /* ========================= */
            close(force=false)
            {
                if(force == true)
                {
                    Navigation.moveBack();
                    return;
                }
                Navigation.moveBack();
            },
        }

        $(document).ready(function()
        {
            /* ======================== */
            /* event */
            /* ======================== */

            /* 금액 입력 시, 업데이트 */
            $("#GFCP-input-capital").keyup(function()
            {
                let original = Number($("#GFCP-span-originalWon").attr("number"));
                let capital  = Number($("#GFCP-input-capital").val().trim());
                let difference = capital - original;
                $("#GFCP-span-capitalWon").html(GGC.Common.priceWon(capital) );
                $("#GFCP-span-differenceWon").html(GGC.Common.priceWon(difference));
            });

            /* 탭 전환 */
            $(".GFCP-btn-tab").click(function()
            {
                let val = $(this).attr("val");
                GFCP.Data.tab = val;
                $(".GFCP-div-tab").hide();
                $(`.GFCP-div-tab[tab="${val}"]`).show();

                /* 이력 탭 표시 */
                switch(val)
                {
                    case "history":
                    {
                        /* get history all */
                        let grpno = GFCP.Data.grpno;
                        let mGrpformnglogs = Api.Grpformnglog.selectGrpfncCapitaltotalByGrpno(grpno, 1);
                        mGrpformnglogs.makeTableForCapital("#GFCP-div-historyAll");
                        break;
                    }
                }
            });

            /*  */
            $("#GFCP-btn-apply").click(function()
            {
                let grpno = GFCP.Data.grpno;
                let capital = $("#GFCP-input-capital").val().trim();
                let comment = $("#GFCP-textarea-comment").val().trim();
                let process = function()
                {
                    Common.showProgress();
                    setTimeout(function()
                    {
                        let mApiResponse = Api.Grpformng.updateCapitaltotalByPk(grpno, capital, comment, GGF.toast, GGF.toast);
                        if(mApiResponse.isSuccess())
                        {
                            Common.hideProgress();
                            return;
                        }
                        Common.hideProgress();
                    }, ajaxDelayTime);
                };
                Common.confirm2(`적용하시겠습니까?`, process);
            });

            /* ========================= */
            /* page process */
            /* ========================= */

            /* get data from Config */
            try
            {
                GFCP.Data = Navigation.getPageParam();
                Navigation.executeShow();
            }
            catch(e)
            {
                console.error(e);
                GFCP.close(true);
            }

        });

    </script>


</ons-page>