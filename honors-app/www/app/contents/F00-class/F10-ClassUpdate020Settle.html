<ons-page id="CUST">

    <style>
        #CUST-tbl-settle
        {
            white-space: nowrap;
        }
        #CUST-tbl-settle > tbody > tr > td:nth-child(1) { text-align: left; }
        #CUST-tbl-settle > tbody > tr > td:nth-child(2) { text-align: right; }
        #CUST-tbl-settle > tbody > tr > td:nth-child(3) { text-align: right; }
        #CUST-tbl-settle > tbody > tr > td[col="username"]          { text-align:left; }
        #CUST-tbl-settle > tbody > tr > td[col="billstand"]         { text-align:right; }
        #CUST-tbl-settle > tbody > tr > td[col="billfinal"]         { text-align:center; }
        #CUST-tbl-settle > tbody > tr > td[col="billadjustment"]    { text-align:center; }
        #CUST-tbl-settle > tbody > tr > td[col="billmemo"]          { text-align:center; }
        #CUST-tbl-settle > tbody > tr > td[col="memberpoint"]       { text-align:right; }
        #CUST-tbl-settle > tbody > tr > td[col="billpointed"]       { text-align:center; }
        #CUST-tbl-settle > tfoot > tr > td { text-align: right; }

        .CUST-input-billfinal         { font-size:1em; width: 6em; vertical-align: middle; text-align: right; }
        .CUST-input-billadjustment    { font-size:1em; width: 6em; vertical-align: middle; text-align: right; }
        .CUST-input-memberpoint       { font-size:1em; width: 6em; vertical-align: middle; text-align: right; }
        .CUST-input-billpointed       { font-size:1em; width: 6em; vertical-align: middle; text-align: right; }
        .CUST-input-billmemo          { font-size:1em; width: 8em; vertical-align: middle; text-align: left; }

        #CUST-tbl-purchase
        {
            white-space: nowrap;
            width: 100%;
        }
        #CUST-tbl-purchase > tbody > tr > td:nth-child(1) { width:10%; }
        #CUST-tbl-purchase > tbody > tr > td:nth-child(2) { width:50%; }
        #CUST-tbl-purchase > tbody > tr > td:nth-child(3) { width:40%; }
        #CUST-tbl-purchase > tfoot > tr > td { text-align: right; }

    </style>

    <!-- ======================== -->
    <!-- í˜ì´ì§€ìš© íƒ€ì´í‹€ -->
    <!-- ======================== -->
    <ons-toolbar>
        <div class="left"><gg-backbtn onclick="CUST.close(true);"></gg-backbtn></div>
        <div class="center">ì •ì‚°</div>
    </ons-toolbar>

    <!-- ========================= -->
    <!-- ì¼ì •ìƒì„¸ -->
    <!-- ========================= -->
    <div class="common-div-cushion">
        <span class="common-tag-block common-tag-fontsize11" id="CUST-span-clstitle"></span>
    </div>

    <!-- ========================= -->
    <!-- íƒ­ -->
    <!-- ========================= -->
    <div class="common-div-cushion">
        <button class="CUST-btn-tab commonEvent-btn-radio common-btn-radio" radio_name="CUST-btn-tab" val="settle"   tab="tab" style="padding-left:0.8em; padding-right:0.8em;"><span class="common-tag-fontsize09">ì°¸ê°€ì •ì‚°</span></button>
        <button class="CUST-btn-tab commonEvent-btn-radio common-btn-radio" radio_name="CUST-btn-tab" val="purchase" tab=""    style="padding-left:0.8em; padding-right:0.8em;"><span class="common-tag-fontsize09">ì†Œë¹„í’ˆëª©</span></button>
    </div>
    <hr class="common-hr-paddingLR">

    <!-- --------------- -->
    <!-- ì°¸ê°€ì •ì‚° -->
    <!-- --------------- -->
    <div class="CUST-div-tab common-div-cushion" tab="settle">
        <p class="common-p-title">ì°¸ê°€ì •ì‚°</p>
        <span class="common-tag-block common-tag-fontsize09">â€»ì°¸ê°€ìë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì²­êµ¬ê¸ˆì•¡ì„ ê³„ì‚°í•˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤.</span>
        <div class="common-div-cushionUD">
            <div class="common-tag-fontsize09">
                <button id="CUST-btn-addSettleItem" class="common-btn-outline">ï¼‹ì°¸ê°€ìì¶”ê°€</button>
                <button id="CUST-btn-saveSettle"  class="common-btn-outline">ğŸ’¿ì„ì‹œì €ì¥</button>
                <button id="CUST-btn-resetSettle" class="common-btn-outline">ğŸ”ƒì´ˆê¸°í™”</button>
            </div>
        </div>
        <div class="common-div-scrollX">
            <table id="CUST-tbl-settle" class="common-tbl-normal common-tag-fontsize09" tbl-type="rowborder">
                <thead>
                    <tr>
                        <th colspan="2">ì°¸ê°€ì</th>
                        <th>ì²­êµ¬ìµœì¢…</th>
                        <th>ì²­êµ¬ê¸ˆì•¡</th>
                        <th>ì²­êµ¬ë³´ì •</th>
                        <th>ì”ì—¬ê¸ˆ</th>
                        <th>ì”ì—¬ê¸ˆì‚¬ìš©</th>
                        <th>ë¹„ê³ (ë³´ì •ì‚¬ìœ ë“±)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2">í•©ê³„</td>
                        <td><span id="CUST-span-billfinalSummary"></span></td>
                        <td><span id="CUST-span-billstandSummary"></span></td>
                        <td><span id="CUST-span-billadjustmentSummary"></span></td>
                        <td>-</span></td>
                        <td><span id="CUST-span-billpointedSummary"></span></td>
                        <td>-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- --------------- -->
    <!-- ì†Œë¹„í’ˆëª© -->
    <!-- --------------- -->
    <div class="CUST-div-tab common-div-cushion" tab="purchase" style="display:none;">
        <p class="common-p-title">ì†Œë¹„í’ˆëª©</p>
        <span class="common-tag-block common-tag-fontsize09">â€»ì¼ì •ì— ì‚¬ìš©ëœ ê¸ˆì•¡ì„ ê¸°ì…í•˜ëŠ” í…Œì´ë¸”ì…ë‹ˆë‹¤.</span>
        <div class="common-div-cushionUD">
            <div class="common-tag-fontsize09">
                <button id="CUST-btn-addPurchaseRow" class="common-btn-outline">ï¼‹í’ˆëª©ì¶”ê°€</button>
                <button id="CUST-btn-savePurchase"   class="common-btn-outline">ğŸ’¿ì„ì‹œì €ì¥</button>
            </div>
        </div>
        <div class="common-div-scrollX">
            <table id="CUST-tbl-purchase" class="common-tbl-normal common-tag-fontsize09" tbl-type="rowborder">
                <thead>
                    <tr>
                        <th colspan="2">í’ˆëª©</th>
                        <th>ê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3">í•©ê³„ : <span id="CUST-span-productbillSummary">0ì›</span></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- ======================== -->
    <!-- footer -->
    <!-- ======================== -->
    <button id="CUST-btn-settleComplete" class="common-btn-footer">ì •ì‚°ì™„ë£Œ</button>
    <div class="common-div-cushionFooter"></div>

    <script>
        var CUST =
        {
            code : "CUST",

            /* ========================= */
            /*
                í˜ì´ì§€ ë°ì´í„°
            */
            /* ========================= */
            Data : {},

            show()
            {
                /* validation param */
                if(CUST.Data.clsno == undefined) { Common.toast("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); CUST.close(); return; }
                if(CUST.Data.grpno == undefined) { Common.toast("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); CUST.close(); return; }

                /* tab */
                $(`.CUST-td-tab[val=decide]`).click();

                /* init */
                Common.showProgress();
                setTimeout(function()
                {
                    try
                    {
                        /* get var */
                        let clsno = CUST.Data.clsno;
                        let grpno = CUST.Data.grpno;

                        /* ê¸°ë³¸ì •ë³´ */
                        let mCls = Api.Cls.selectByPkForAll(grpno, clsno, GGF.none, GGF.toast);
                        $("#CUST-span-clstitle").text(mCls.getClstitle());

                        /* ì •ì‚°ì´ˆê¸°í™” */
                        CUST.resetSettle();

                        /* êµ¬ë§¤ì´ˆê¸°í™” */
                        $("#CUST-tbl-purchase > tbody").empty();
                        let mClspurchases = Api.Clspurchase.selectByClsno(grpno, clsno);
                        let purchaseModels = mClspurchases.getModels();
                        for(let i in purchaseModels)
                        {
                            let model = purchaseModels[i];
                            CUST.addRowForPurchase(model);
                        }
                        CUST.setEventForPurchase();
                        CUST.calSummaryPurchase();
                    }
                    catch(e)
                    {
                        Common.catchProc(e);
                    }
                    Common.hideProgress();
                }, ajaxDelayTime);
            },

            resetSettle()
            {
                /* get var */
                let clsno = CUST.Data.clsno;
                let grpno = CUST.Data.grpno;

                /* ì„ì‹œì €ì¥ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ */
                $("#CUST-tbl-settle > tbody").empty();
                let mClssettletmps = Api.Clssettletmp.selectByClsno(grpno, clsno);
                for(let i in mClssettletmps.getModels())
                {
                    let model = mClssettletmps.getModels()[i];
                    CUST.addRowForSettleByClssettletmp(model);
                }

                /* ì„ì‹œì €ì¥ë°ì´í„°ê°€ ì—†ìœ¼ë©´, ë¼ì¸ì—…ìœ¼ë¡œë¶€í„° ì‘ì„± */
                if(mClssettletmps.getModels().length == 0)
                {
                    let mClslineup2s = Api.Clslineup2.selectByClsnoForSettleForMng(grpno, clsno, GGF.none, GGF.toast);
                    let lineups = mClslineup2s.getModels();
                    for(let i in lineups)
                        CUST.addRowForSettle(lineups[i]);
                }
                CUST.setEventForSettle();
                CUST.calSummarySettle();
            },

            addRowForPurchase(mClspurchase)
            {
                let html =
                `
                    <tr purchaseidx="${mClspurchase.getPurchaseidx()}">
                        <td col="btn"           ><button class="CUST-btn-deleteRowForPurchase common-btn-outline" btn-type="cancel" purchaseidx="${mClspurchase.getPurchaseidx()}">ì‚­ì œ</button></td>
                        <td col="productname"   ><input type="text"   class="common-input-text CUST-input-productname" value="${mClspurchase.getProductname()}" style="width:100%;" /></td>
                        <td col="productbill"   ><input type="number" class="common-input-text CUST-input-productbill" value="${mClspurchase.getProductbill()}" style="width:100%;" /></td>
                    </tr>
                `;
                $(`#CUST-tbl-purchase > tbody`).append(html);
            },

            addRowForSettle(model)
            {
                let html =
                `
                    <tr userno="${model.getUserno()}">
                        <td col="btn"                                               ><button class="CUST-btn-deleteRowForSettle common-btn-outline" btn-type="cancel" userno="${model.getUserno()}">ì‚­ì œ</button></td>
                        <td col="username"         userno="${model.getUserno()}"    >${model.getUsername()}</td>
                        <td col="billfinal"                                         ><input type="text"   class="common-input-text CUST-input-billfinal"        userno="${model.getUserno()}" value="${model.getBillWon()}" subvalori="${model.getBill()}" subval="${model.getBill()}" disabled></td>
                        <td col="billstand"        subval="${model.getBill()}"      >${model.getBillWon()}</td>
                        <td col="billadjustment"                                    ><input type="number" class="common-input-text CUST-input-billadjustment"   userno="${model.getUserno()}" value="0"></td>
                        <td col="memberpoint"                                       ><input type="text"   class="common-input-text CUST-input-memberpoint"      userno="${model.getUserno()}" value="${model.getMemberpointWon()}" subval="${model.getMemberpoint()}" disabled></td>
                        <td col="billpointed"                                       ><input type="number" class="common-input-text CUST-input-billpointed"      userno="${model.getUserno()}" value="0"></td>
                        <td col="billmemo"                                          ><input type="text"   class="common-input-text CUST-input-billmemo"         userno="${model.getUserno()}" value=""></td>
                    </tr>
                `;
                $(`#CUST-tbl-settle > tbody`).append(html);
            },

            addRowForSettleByClssettletmp(model)
            {
                let html =
                `
                    <tr userno="${model.getUserno()}">
                        <td col="btn"                                                       ><button class="CUST-btn-deleteRowForSettle common-btn-outline" btn-type="cancel" userno="${model.getUserno()}">ì‚­ì œ</button></td>
                        <td col="username"         userno="${model.getUserno()}"            >${model.getUsername()}</td>
                        <td col="billfinal"                                                 ><input type="text"   class="common-input-text CUST-input-billfinal"        userno="${model.getUserno()}" value="${model.getBillstandardWon()}" subvalori="${model.getBillstandard()}" subval="${model.getBillstandard()}" disabled></td>
                        <td col="billstand"        subval="${model.getBillstandard()}"      >${model.getBillstandardWon()}</td>
                        <td col="billadjustment"                                            ><input type="number" class="common-input-text CUST-input-billadjustment"   userno="${model.getUserno()}" value="0"></td>
                        <td col="memberpoint"                                               ><input type="text"   class="common-input-text CUST-input-memberpoint"      userno="${model.getUserno()}" value="${model.getGrpmPointWon()}" subval="${model.getGrpmPoint()}" disabled></td>
                        <td col="billpointed"                                               ><input type="number" class="common-input-text CUST-input-billpointed"      userno="${model.getUserno()}" value="0"></td>
                        <td col="billmemo"                                                  ><input type="text"   class="common-input-text CUST-input-billmemo"         userno="${model.getUserno()}" value=""></td>
                    </tr>
                `;
                $(`#CUST-tbl-settle > tbody`).append(html);
            },

            checkDuplicateSettleUser(userno)
            {
                let isDuplicate = false;
                $("#CUST-tbl-settle > tbody > tr").each(function()
                {
                    let existUserno = $(this).attr("userno");
                    if(existUserno == userno)
                        isDuplicate = true;
                });
                return isDuplicate;
            },

            calSummarySettle()
            {
                let billstandSummary = 0;
                let billfinalSummary = 0;
                let billadjustmentSummary = 0;
                let billpointedSummary = 0;

                /* í•©ê³„ */
                $("#CUST-tbl-settle > tbody > tr").each(function()
                {
                    let billstand       = parseInt($(this).find("td[col=billstand]").attr("subval"));
                    let billfinal       = parseInt($(this).find("td[col=billfinal] > input").attr("subval"));
                    let billadjustment  = parseInt($(this).find("td[col=billadjustment] > input").val());
                    let billpointed     = parseInt($(this).find("td[col=billpointed] > input").val());

                    if(isNaN(billstand)) return;
                    if(isNaN(billfinal)) return;
                    if(isNaN(billadjustment)) return;
                    if(isNaN(billpointed)) return;

                    billstandSummary += billstand;
                    billfinalSummary += billfinal;
                    billadjustmentSummary += billadjustment;
                    billpointedSummary += billpointed;
                });

                $("#CUST-span-billstandSummary").text(GGC.Common.priceWon(billstandSummary));
                $("#CUST-span-billfinalSummary").text(GGC.Common.priceWon(billfinalSummary));
                $("#CUST-span-billadjustmentSummary").text(GGC.Common.priceWon(billadjustmentSummary));
                $("#CUST-span-billpointedSummary").text(GGC.Common.priceWon(billpointedSummary));
            },

            calSummaryPurchase()
            {
                let productbillTotal = 0;
                $("#CUST-tbl-purchase > tbody > tr").each(function()
                {
                    let productbill = parseInt($(this).find("td[col=productbill] > input").val());
                    if(isNaN(productbill)) return;
                    productbillTotal += productbill;
                });
                $("#CUST-span-productbillSummary").text(GGC.Common.priceWon(productbillTotal));
            },

            setEventForSettle()
            {
                /* --------------- */
                /* settle : í–‰ì‚­ì œ */
                /* --------------- */
                $(".CUST-btn-deleteRowForSettle").off("click").on("click", function()
                {
                    let userno = $(this).attr("userno");
                    let process = function()
                    {
                        /* remove row */
                        $(`#CUST-tbl-settle > tbody > tr[userno=${userno}]`).remove();
                        CUST.calSummarySettle();
                    }
                    Common.confirm2("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", process);
                });

                /* --------------- */
                /* settle : ì²­êµ¬ë³´ì • */
                /* --------------- */
                $(".CUST-input-billadjustment").off("keyup").on("keyup", function()
                {
                    /* vars */
                    let userno              = $(this).attr("userno");
                    let billfinalEl         = $(`.CUST-input-billfinal[userno=${userno}]`);
                    let billadjustmentEl    = $(this);
                    let billpointedEl       = $(`.CUST-input-billpointed[userno=${userno}]`);
                    let billfinal           = parseInt(billfinalEl.attr("subval"));
                    let billfinalOri        = parseInt(billfinalEl.attr("subvalori"));
                    let billadjustment      = parseInt(billadjustmentEl.val());
                    let billpointed         = parseInt(billpointedEl.val());

                    /* validation */
                    if(isNaN(billadjustment))
                        return;

                    let result = billfinalOri + billadjustment - billpointed;
                    billfinalEl.attr("subval", result);
                    billfinalEl.val(GGC.Common.priceWon(result));
                    CUST.calSummarySettle();
                });

                /* --------------- */
                /* settle : ì”ì—¬ê¸ˆ */
                /* --------------- */
                $(".CUST-input-billpointed").off("keyup").on("keyup", function()
                {
                    let userno              = $(this).attr("userno");
                    let billfinalEl         = $(`.CUST-input-billfinal[userno=${userno}]`);
                    let billadjustmentEl    = $(`.CUST-input-billadjustment[userno=${userno}]`);
                    let billpointedEl       = $(this);
                    let billfinal           = parseInt(billfinalEl.attr("subval"));
                    let billfinalOri        = parseInt(billfinalEl.attr("subvalori"));
                    let billadjustment      = parseInt(billadjustmentEl.val());
                    let billpointed         = parseInt(billpointedEl.val());
                    let memberpoint         = parseInt($(`.CUST-input-memberpoint[userno=${userno}]`).attr("subval"));

                    if(isNaN(billpointed)) return;
                    if(billpointed > memberpoint) { Common.toast("ì”ì—¬ê¸ˆ ì‚¬ìš©ê¸ˆì•¡ì´ ì”ì—¬ê¸ˆë³´ë‹¤ ë§ìŠµë‹ˆë‹¤."); $(this).val(0); $(this).keyup(); return; }

                    let result = billfinalOri + billadjustment - billpointed;
                    billfinalEl.attr("subval", result);
                    billfinalEl.val(GGC.Common.priceWon(result));
                    CUST.calSummarySettle();
                });
                /* ì…ë ¥í•­ëª©ì´ ê³µë°±ì¼ ë•Œ */
                $(".CUST-input-billadjustment") .off("change").on("change", function() { if($(this).val() == "") $(this).val(0); $(this).keyup(); });
                $(".CUST-input-billpointed")    .off("change").on("change", function() { if($(this).val() == "") $(this).val(0); $(this).keyup(); });
            },

            setEventForPurchase()
            {

                /* --------------- */
                /* purchase : í–‰ì‚­ì œ */
                /* --------------- */
                $(".CUST-btn-deleteRowForPurchase").off("click").on("click", function()
                {
                    let purchaseidx = $(this).attr("purchaseidx");
                    let process = function()
                    {
                        /* remove row */
                        $(`#CUST-tbl-purchase > tbody > tr[purchaseidx=${purchaseidx}]`).remove();
                        CUST.calSummaryPurchase();
                    }
                    Common.confirm2("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", process);
                });

                /* --------------- */
                /* purchase : ê¸ˆì•¡ */
                /* --------------- */
                $(".CUST-input-productbill").off("keyup").on("keyup", function()
                {
                    CUST.calSummaryPurchase();
                });
                /* ì…ë ¥í•­ëª©ì´ ê³µë°±ì¼ ë•Œ */
                $(".CUST-input-productbill").off("change").on("change", function() { if($(this).val() == "") $(this).val(0); $(this).keyup(); });
            },

            /* ========================= */
            /* ì •ì‚°ì •ë³´ìˆ˜ì§‘ */
            /* ========================= */
            getArrForSettle()
            {
                let arr = [];
                $("#CUST-tbl-settle > tbody > tr").each(function()
                {
                    let userno              = $(this).attr("userno");
                    let billstand           = parseInt($(this).find("td[col=billstand]").attr("subval"));
                    let billfinal           = parseInt($(this).find("td[col=billfinal] > input").attr("subval"));
                    let billadjustment      = parseInt($(this).find("td[col=billadjustment] > input").val());
                    let billpointed         = parseInt($(this).find("td[col=billpointed] > input").val());
                    let billmemo            = $(this).find("td[col=billmemo] > input").val();
                    let dat =
                    {
                        USERNO        : userno,
                        BILLSTANDARD  : billstand,
                        BILLADJUSTMENT  : billadjustment,
                        BILLPOINTED   : billpointed,
                        BILLFINAL     : billfinal,
                        BILLMEMO      : billmemo,
                    }
                    arr.push(dat);
                });
                return arr;
            },

            /* ========================= */
            /* êµ¬ë§¤ì •ë³´ìˆ˜ì§‘ */
            /* ========================= */
            getArrForPurchase()
            {
                let arr = [];
                $("#CUST-tbl-purchase > tbody > tr").each(function()
                {
                    let productname = $(this).find("td[col=productname] > input").val();
                    let productbill = $(this).find("td[col=productbill] > input").val();

                    let productnameEmpty = Common.isEmpty(productname);
                    let productbillEmpty = Common.isEmpty(productbill) || productbill == "0";
                    if      (productnameEmpty && productbillEmpty)  { return; }
                    else if (productnameEmpty)                      { Common.toast("í’ˆëª©ëª…ì´ ë¹„ì–´ìˆëŠ” í–‰ì´ ìˆìŠµë‹ˆë‹¤."); throw new Error("empty row"); }
                    else if (productbillEmpty)                      { Common.toast("ê¸ˆì•¡ì´ ë¹„ì–´ìˆëŠ” í–‰ì´ ìˆìŠµë‹ˆë‹¤."); throw new Error("empty row"); }

                    let dat =
                    {
                        PRODUCTNAME : productname,
                        PRODUCTBILL : productbill,
                    }
                    arr.push(dat);
                });
                return arr;
            },

            /* ========================= */
            /* close */
            /* ========================= */
            close(force=false)
            {
                if(force == true)
                {
                    Navigation.moveBack();
                    return;
                }
                Common.confirmClose();
            },
        }

        $(document).ready(function()
        {
            /* ========================= */
            /* event */
            /* ========================= */


            /* =============== */
            /* íƒ­ */
            /* =============== */
            $(".CUST-btn-tab").click(function()
            {
                /* ì„ íƒëœ íƒ­ í‘œì‹œ */
                let tab = $(this).attr("val");
                $(".CUST-btn-tab").removeAttr("tab");
                $(this).attr("tab", "tab");

                /* íƒ­ë³„ í‘œì‹œ */
                $(".CUST-div-tab").hide();
                $(`.CUST-div-tab[tab=${tab}]`).show();
            });

            /* =============== */
            /* settle : ì°¸ê°€ìì¶”ê°€ */
            /* =============== */
            $("#CUST-btn-addSettleItem").click(function()
            {
                /* ëŒì•„ì™”ì„ ë•Œ, show ë°©ì§€ */
                CUST.Data.executeShowWhenClose = false;

                /* ë‹¤ì´ì–¼ë¡œê·¸ */
                let grpno = CUST.Data.grpno;
                let clsno = CUST.Data.clsno;
                let teamname = "for-settle";
                let data =
                {
                    option : "F10ClassUpdate020Settle-addSettleUser",
                    grpno : grpno,
                    clsno : clsno,
                    teamname : teamname,
                    regmember : GGF.Y,
                }
                Navigation.moveFrontDialog(Navigation.Page.S10ChooseGrpMember, data);
            });

            /* =============== */
            /* settle : ì„ì‹œì €ì¥ */
            /* =============== */
            $("#CUST-btn-saveSettle").click(function()
            {
                Common.showProgress();
                setTimeout(function()
                {
                    try
                    {
                        let clsno = CUST.Data.clsno;
                        let grpno = CUST.Data.grpno;
                        let arr = CUST.getArrForSettle();
                        let mApiResponse = Api.Clssettletmp.insertByArr(grpno, clsno, JSON.stringify(arr), GGF.toast, GGF.toast);
                    }
                    catch(e)
                    {
                        Common.catchProc(e);
                    }
                    Common.hideProgress();
                }, ajaxDelayTime);
            });

            /* =============== */
            /* settle : ì´ˆê¸°í™” */
            /* =============== */
            $("#CUST-btn-resetSettle").click(function()
            {
                let process = function()
                {
                    Common.showProgress();
                    setTimeout(function()
                    {
                        try
                        {
                            let clsno = CUST.Data.clsno;
                            let grpno = CUST.Data.grpno;

                            /* ì‚­ì œ */
                            let mApiResponse = Api.Clssettletmp.deleteByClsno(grpno, clsno, GGF.toast, GGF.toast);
                            if(mApiResponse.isSuccess())
                                CUST.resetSettle();
                        }
                        catch(e)
                        {
                            Common.catchProc(e);
                        }
                        Common.hideProgress();
                    }, ajaxDelayTime);
                }
                Common.confirm2("ì •ì‚°ì •ë³´ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", process);
            });

            /* =============== */
            /* purchase : ì†Œë¹„í’ˆëª©ì¶”ê°€ */
            /* =============== */
            $("#CUST-btn-addPurchaseRow").click(function()
            {
                /* find next purchaseidx */
                let purchaseidx = 1;
                $("#CUST-tbl-purchase > tbody > tr").each(function()
                {
                    let existPurchaseidx = parseInt($(this).attr("purchaseidx"));
                    if(purchaseidx <= existPurchaseidx)
                        purchaseidx = existPurchaseidx + 1;
                });

                let dat =
                {
                    PURCHASEIDX : purchaseidx,
                    PRODUCTNAME : "",
                    PRODUCTBILL : 0,
                }
                let mClspurchase = new MClspurchase(dat);
                CUST.addRowForPurchase(mClspurchase);
                CUST.setEventForPurchase();
            });

            /* =============== */
            /* purchase : ì„ì‹œì €ì¥ */
            /* =============== */
            $("#CUST-btn-savePurchase").click(function()
            {
                Common.showProgress();
                setTimeout(function()
                {
                    try
                    {
                        let clsno = CUST.Data.clsno;
                        let grpno = CUST.Data.grpno;
                        let arr = CUST.getArrForPurchase();
                        let mApiResponse = Api.Clspurchase.insertByArr(grpno, clsno, JSON.stringify(arr), GGF.toast, GGF.toast);
                    }
                    catch(e)
                    {
                        Common.catchProc(e);
                    }
                    Common.hideProgress();
                }, ajaxDelayTime);
            });

            /* =============== */
            /* ì €ì¥ */
            /* =============== */
            $("#CUST-btn-settleComplete").click(function()
            {
                let process = function()
                {
                    Common.showProgress();
                    setTimeout(function()
                    {
                        try
                        {
                            let clsno = CUST.Data.clsno;
                            let grpno = CUST.Data.grpno;
                            let arrForSettle = CUST.getArrForSettle();
                            // let arrForPurchase = CUST.getArrForPurchase();
                            let mApiResponse = Api.Cls.updateClsSettleInfoByPk(grpno, clsno, JSON.stringify(arrForSettle), GGF.toast, GGF.toast);
                            if(mApiResponse.isSuccess())
                                Navigation.moveBack();
                        }
                        catch(e)
                        {
                            Common.catchProc(e);
                        }
                        Common.hideProgress();
                    }, ajaxDelayTime);
                }
                Common.confirm2("ì²˜ë¦¬ í›„ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", process);
            });


            /* ========================= */
            /* page process */
            /* ========================= */

            /* get data from Config */
            try
            {
                CUST.Data = Navigation.getPageParam();
                Navigation.executeShow();
            }
            catch(e)
            {
                console.error(e);
                CUST.close(true);
            }

            /* localizing */
            /* $("#CUST").i18n(); */

        }); /* end function */

    </script>
</ons-page>