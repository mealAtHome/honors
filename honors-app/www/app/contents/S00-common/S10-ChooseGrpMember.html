<ons-page id="CHGM">

    <!-- --------------- -->
    <!-- í˜ì´ì§€ìš© íƒ€ì´í‹€ -->
    <!-- --------------- -->
    <ons-toolbar id="CHGM-toolbar">
        <div class="left"><gg-backbtn onclick="CHGM.close(true);"></gg-backbtn></div>
        <div class="center"><span id="CHGM-span-title">ë©¤ë²„ì„ íƒ</span></div>
    </ons-toolbar>

    <!-- --------------- -->
    <!-- íƒ­ -->
    <!-- --------------- -->
    <!-- <div id="CHGM-div-tabBtn" class="common-div-cushion" style="display:none;"> -->
    <!--     <button class="CHGM-btn-tab commonEvent-btn-radio common-btn-radio" radio_name="CHGM-btn-tab" val="origin" tab="tab">ê¸°ì¡´ë©¤ë²„ì—ì„œ</button> -->
    <!--     <button class="CHGM-btn-tab commonEvent-btn-radio common-btn-radio" radio_name="CHGM-btn-tab" val="temp"   tab="">ì„ì‹œë©¤ë²„ìƒì„±</button> -->
    <!--     <hr class="common-hr-paddingUD"/> -->
    <!-- </div> -->

    <!-- --------------- -->
    <!-- ê¸°ì¡´ë©¤ë²„ -->
    <!-- --------------- -->
    <div class="CHGM-div-tabDiv" screen-tab="origin">
        <style>
            #CHGM-input-searchKeyword
            {
                width:13em;
                font-size:1em;
                line-height:1.5;
                vertical-align: middle;
            }
            #CHGM-btn-search
            {
                padding-left  : 1em;
                padding-right : 1em;
                font-size:1em;
                line-height:1.5;
                vertical-align: middle;
            }
        </style>
        <div class="common-div-cushion">
            <input type="text" id="CHGM-input-searchKeyword" class="common-input-text"/>
            <button id="CHGM-btn-search" class="common-btn-outline" btn-size="search">ğŸ” ê²€ìƒ‰</button>
        </div>

        <!-- ======================== -->
        <!-- ê²€ìƒ‰ê²°ê³¼ -->
        <!-- ======================== -->
        <hr class="common-hr-padding"/>
        <div id="CHGM-div-searchResult"></div>
    </div>

    <!-- --------------- -->
    <!-- ì„ì‹œë©¤ë²„ìƒì„± -->
    <!-- --------------- -->
    <div class="CHGM-div-tabDiv" screen-tab="temp" style="display:none;">
        <div class="common-div-form">
            <span>ì´ë¦„</span>
            <span>ì‹¤ëª…ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
            <div class="common-div-cushionUD">
                <input type="text" id="CHGM-input-username" class="common-input-text" style="width:15em;"/>
            </div>
        </div>
        <div class="common-div-form">
            <span>ì”ì—¬ê¸ˆ</span>
            <span>ì„ ë‚©ëœ ê¸ˆì•¡ì´ ìˆìœ¼ë©´ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
            <div class="common-div-cushionUD">
                <input type="text" id="CHGM-input-point" class="common-input-text" style="width:15em;"/>
                <span id="CHGM-span-pointWon" class="common-tag-block common-tag-fontsize09"></span>
            </div>
        </div>
        <div class="common-div-form">
            <button id="CHGM-btn-createTempUser" class="common-btn-inline" btn-size="large">ì„ì‹œìœ ì € ìƒì„±í•˜ê³  í¬ì§€ì…˜ì— ê¸°ì…</button>
        </div>
    </div>

    <script>
        var CHGM =
        {
            code : "CHGM",
            Data: {},

            /* ===================== */
            /* show */
            /* ===================== */
            show()
            {
                if(CHGM.Data.option     == undefined) { CHGM.Data.option = ""; }
                if(CHGM.Data.grpno      == undefined) { CHGM.Data.grpno = ""; }
                if(CHGM.Data.clsno      == undefined) { CHGM.Data.clsno = ""; }
                if(CHGM.Data.teamname   == undefined) { CHGM.Data.teamname = ""; }
                if(CHGM.Data.orderno    == undefined) { CHGM.Data.orderno = ""; }
                if(CHGM.Data.el         == undefined) { CHGM.Data.el = ""; }
                if(CHGM.Data.regmember  == undefined) { CHGM.Data.regmember = ""; }
                if(CHGM.Data.title      == undefined) { CHGM.Data.title = ""; }

                /* title */
                if(CHGM.Data.title != "")
                    $("#CHGM-span-title").text(CHGM.Data.title);

                /* view div by option */
                if(CHGM.Data.regmember == GGF.Y)
                {
                    $("#CHGM-div-tabBtn").show();
                    $(".CHGM-div-tabDiv").hide();
                    $(".CHGM-div-tabDiv[screen-tab='origin']").show();
                }
                else
                {
                    $("#CHGM-div-tabBtn").hide();
                    $(".CHGM-div-tabDiv").hide();
                    $(".CHGM-div-tabDiv[screen-tab='origin']").show();
                }

                /* search for init */
                $("#CHGM-btn-search").click();
            },

            /* ===================== */
            /* option ì— ë”°ë¥¸ ì•¡ì…˜ (ë‹¹ì‹œëŠ” "ëŒ€ë¦¬ì°¸ê°€" ê¸°ëŠ¥ì— ì‚¬ìš©) */
            /* ===================== */
            actionByOption(userno, forceflg=false)
            {
                /* vars */
                let grpno = CHGM.Data.grpno;
                let clsno = CHGM.Data.clsno;
                let teamname = CHGM.Data.teamname;
                let orderno = CHGM.Data.orderno;

                /* process */
                let process = null;
                switch(CHGM.Data.option)
                {
                    case "makeToEl":
                    {
                        let mGrpMember = Api.GrpMember.selectByPkForAll(grpno, userno);
                        if(mGrpMember == null)
                            return Common.toast("í•´ë‹¹ ê·¸ë£¹ì˜ ë©¤ë²„ê°€ ì•„ë‹™ë‹ˆë‹¤.");

                        let mUser = mGrpMember.getMUser();
                        $(CHGM.Data.el).html(mGrpMember.make());
                        $(CHGM.Data.el).attr("grpno", grpno);
                        $(CHGM.Data.el).attr("userno", userno);
                        $(CHGM.Data.el).attr("name", mUser.getName());
                        Navigation.moveBack();
                        break;
                    }
                    case "F00-applyToClslineup2":
                    {
                        let etc = "ê´€ë¼ìì— ì˜í•œ ëŒ€ë¦¬ì ‘ìˆ˜";
                        process = function()
                        {
                            Common.showProgress();
                            setTimeout(function()
                            {
                                let mApiResponse = Api.Clslineup2.updateApplyRegistStead(grpno, clsno, teamname, orderno, userno, etc, GGF.toast, GGF.toast);
                                if(mApiResponse.isSuccess())
                                    Navigation.moveBack();

                                Common.hideProgress();
                            }, ajaxDelayTime);
                        };
                        Common.confirm2(`ì°¸ê°€ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, process);
                        break;
                    }
                    case "F10ClassUpdate020Settle-addSettleUser":
                    {
                        /* check duplicate user */
                        if(CUST.checkDuplicateSettleUser(userno)) { Common.toast("ì´ë¯¸ ì¶”ê°€ëœ ì°¸ê°€ìì…ë‹ˆë‹¤."); return; }

                        /* get userinfo */
                        let mGrpMember = Api.GrpMember.selectByPkForMng(grpno, userno);
                        if(mGrpMember == null)
                            return Common.toast("í•´ë‹¹ ê·¸ë£¹ì˜ ë©¤ë²„ê°€ ì•„ë‹™ë‹ˆë‹¤.");

                        /* get mCls */
                        let mCls = Api.Cls.selectByPkForAll(grpno, clsno, GGF.none, GGF.toast);

                        /* make model */
                        let mUser = mGrpMember.getMUser();
                        let dat =
                        {
                            grpno       : grpno,
                            clsno       : clsno,
                            teamname    : teamname,
                            userno      : userno,
                            username    : mUser.getName(),
                            bill        : mCls.getClsbillapplyprice(),
                            memberpoint : mUser.getPoint(),
                        }
                        let mClslineup2 = new MClslineup2(dat);
                        CUST.addRowForSettleByClslineup2(mClslineup2);
                        Navigation.moveBack();

                        /* event */
                        CUST.setEventForSettle();
                        CUST.calSummarySettle();
                        break;
                    }
                }
            },

            /* ========================= */
            /* close */
            /* ========================= */
            close(force=false)
            {
                if(force == true)
                {
                    Navigation.moveBack();
                    return;
                }
                Navigation.moveBack();
            },
        }

        $(document).ready(function()
        {
            /* ======================== */
            /* event */
            /* ======================== */

            /* íƒ­ */
            $(".CHGM-btn-tab").click(function()
            {
                let val = $(this).attr("val");
                $(".CHGM-div-tabDiv").hide();
                $(`.CHGM-div-tabDiv[screen-tab="${val}"]`).show();
            });

            /* ì„ì‹œìœ ì € ìƒì„±í•˜ê³  í¬ì§€ì…˜ì— ê¸°ì…í•˜ê¸° */
            $("#CHGM-btn-createTempUser").click(function()
            {
                /* check username */
                let username = $("#CHGM-input-username").val().trim();
                if(username == "")
                    return Common.toast("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                if(GGvalid.Common.hasSpecialChar(username))
                    return Common.toast("ì´ë¦„ì— íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                /* check point */
                let point = $("#CHGM-input-point").val().trim();
                if(point == "")
                    point = "0";

                /* process */
                Common.showProgress();
                setTimeout(function()
                {
                    /* make user */
                    let grpno = CHGM.Data.grpno;
                    let mApiResponse = Api.GrpMember.makeTempUserForMng(grpno, username, point, GGF.none, GGF.toast);
                    if(!mApiResponse.isSuccess())
                    {
                        Common.hideProgress();
                        return;
                    }
                    Common.hideProgress();

                    /* apply to lineup */
                    CHGM.actionByOption(mApiResponse.getUserno(), true);
                }, ajaxDelayTime);
            });

            /* ê²€ìƒ‰ */
            $("#CHGM-btn-search").click(function()
            {
                /* validation */
                let keyword = $("#CHGM-input-searchKeyword").val();
                if(GGvalid.Common.hasSpecialChar(keyword))
                    return Common.toast("ê²€ìƒ‰ì–´ì— íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "warning");

                /* search */
                Common.showProgress();
                setTimeout(function()
                {
                    /* sendData */
                    let mGrpMembers = Api.GrpMember.selectByKeywordForAll(CHGM.Data.grpno, keyword);
                    mGrpMembers.makeForChoose("#CHGM-div-searchResult");

                    /* ì„ íƒë²„íŠ¼ ëˆ„ë¥¼ ì‹œ */
                    $("#CHGM-div-searchResult .MGrpMember-make-btn-choose").off("click").on("click", function()
                    {
                        let userno = $(this).attr("userno");
                        CHGM.actionByOption(userno);
                    });

                    Common.hideProgress();
                }, ajaxDelayTime);
            });

            /* ========================= */
            /* page process */
            /* ========================= */

            /* get data from Config */
            try
            {
                CHGM.Data = Navigation.getPageParam();
                Navigation.executeShow();
            }
            catch(e)
            {
                console.error(e);
                CHGM.close(true);
            }

        });

    </script>


</ons-page>